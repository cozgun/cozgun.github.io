<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Songs Viewer</title>
  <style>
    :root { --max-width: 1100px; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f7f7f9; color: #222; }
    header { background: #ffffff; border-bottom: 1px solid #e6e6ee; }
    .wrap { max-width: var(--max-width); margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 1.4rem; }
    .cfg { font-size: .9rem; color: #666; }
    nav { padding: 8px 0 12px; overflow-x: auto; }
    .toc { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding: 0; margin: 0; }
    .toc a { display: inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid #e0e0ea; text-decoration: none; color: #333; background: #fff; }
    .toc a:hover { background: #f1f1f7; }
    main { max-width: var(--max-width); margin: 12px auto 56px; padding: 0 16px 24px; }
    section { background: #fff; border: 1px solid #e6e6ee; border-radius: 16px; margin: 18px 0; box-shadow: 0 6px 16px rgba(16,24,40,.04); }
    h2 { margin: 0; padding: 16px; font-size: 1.1rem; border-bottom: 1px solid #eee; }
    iframe, object, embed { width: 100%; height: 820px; border: none; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }
    .empty { text-align: center; color: #666; padding: 64px 16px; }
    footer { text-align: center; color: #888; font-size: .85rem; padding: 24px; }
    .hint { font-size: .9rem; color: #666; }
    .floating-top { position: fixed; right: 20px; bottom: 20px; background: #fff; border: 1px solid #e6e6ee; border-radius: 999px; padding: 10px 14px; text-decoration: none; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,.06); }
    .toc-inline { border-top: 1px solid #eee; padding: 12px 16px; background: #fafafa; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Song Sheets Viewer</h1>
      <div class="cfg" id="cfgText"></div>
      <nav aria-label="Sayfa içi linkler">
        <ul class="toc" id="toc"></ul>
      </nav>
    </div>
  </header>

  <main id="content">
    <div class="empty" id="empty">Songs klasöründe 1.pdf, 2.pdf, 3.pdf ... şeklinde dosyalar bulunursa burada görünecek.</div>
  </main>

  <a href="#top" class="floating-top" title="Başa dön">▲ Başa dön</a>

  <footer>
    <div class="wrap hint">
      Bu dosyayı, <code>Songs</code> adlı klasörle aynı dizine koyun. PDF'ler <code>Songs/1.pdf, Songs/2.pdf...</code> diye adlandırılmalı.
    </div>
  </footer>

  <script>
    const FOLDER = 'Songs';
    const START_INDEX = 1;
    const MAX_FILES = 200;
    const PDF_HEIGHT = 820;

    const params = new URLSearchParams(location.search);
    const folder = params.get('folder') || FOLDER;
    const startIndex = parseInt(params.get('start') || START_INDEX, 10);
    const maxFiles = parseInt(params.get('max') || MAX_FILES, 10);

    document.getElementById('cfgText').textContent = `Klasör: ${folder} · Taranan aralık: ${startIndex} → ${startIndex + maxFiles - 1}`;

    async function urlExists(url) {
      try {
        const head = await fetch(url, { method: 'HEAD' });
        if (head.ok) return true;
        if (head.status === 405) {
          const get = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' } });
          return get.ok;
        }
        return false;
      } catch (e) {
        return false;
      }
    }

    function createTOC(indices) {
      const toc = document.createElement('ul');
      toc.className = 'toc';
      for (const i of indices) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#song-${i}`;
        a.textContent = `Dosya ${i}`;
        li.appendChild(a);
        toc.appendChild(li);
      }
      return toc;
    }

    function addTOCItem(i) {
      const toc = document.getElementById('toc');
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#song-${i}`;
      a.textContent = `Dosya ${i}`;
      li.appendChild(a);
      toc.appendChild(li);
    }

    function addPDFSection(i, url, indices) {
      const content = document.getElementById('content');
      document.getElementById('empty')?.remove();

      const sect = document.createElement('section');

      const h = document.createElement('h2');
      h.id = `song-${i}`;
      h.textContent = `${i}.pdf`;
      sect.appendChild(h);

      const frame = document.createElement('iframe');
      frame.loading = 'lazy';
      frame.height = PDF_HEIGHT;
      frame.src = url;
      frame.title = `${i}.pdf`;

      frame.addEventListener('error', () => {
        const fallback = document.createElement('div');
        fallback.style.padding = '16px';
        fallback.innerHTML = `PDF görüntülenemedi. <a href="${url}">Dosyayı indir / aç</a>.`;
        sect.appendChild(fallback);
      });

      sect.appendChild(frame);

      // Inline TOC ekle
      const tocInline = document.createElement('div');
      tocInline.className = 'toc-inline';
      tocInline.appendChild(createTOC(indices));
      sect.appendChild(tocInline);

      content.appendChild(sect);
    }

    (async function build() {
      let indices = [];
      try {
        const manifest = await fetch(`${folder}/index.json`, { cache: 'no-store' });
        if (manifest.ok) {
          const data = await manifest.json();
          if (Array.isArray(data.files)) {
            indices = data.files.map(Number).filter(n => Number.isFinite(n));
          }
        }
      } catch (_) {}

      if (indices.length === 0) {
        const probes = [];
        for (let i = startIndex; i < startIndex + maxFiles; i++) {
          const url = `${folder}/${i}.pdf`;
          probes.push((async () => (await urlExists(url)) ? i : null)());
        }
        const results = await Promise.all(probes);
        indices = results.filter(n => n !== null);
      }

      if (indices.length === 0) {
        const empty = document.getElementById('empty');
        empty.innerHTML = `Hiç dosya bulunamadı. Lütfen bu HTML dosyasını <code>${folder}</code> klasörüyle aynı dizine koyun ve PDF'leri <code>1.pdf, 2.pdf, 3.pdf</code> şeklinde adlandırın.`;
        return;
      }

      indices.sort((a, b) => a - b);

      for (const i of indices) {
        const url = `${folder}/${i}.pdf`;
        addTOCItem(i);
        addPDFSection(i, url, indices);
      }
    })();
  </script>
</body>
</html>
